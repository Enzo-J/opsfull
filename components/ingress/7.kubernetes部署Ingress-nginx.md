# 一、Ingress-nginx简介
```
Pod的IP以及service IP只能在集群内访问，如果想在集群外访问kubernetes提供的服务，可以使用nodeport、proxy、loadbalacer以及ingress等方式，由于service的IP集群外不能访问，就是使用ingress方式再代理一次，即ingress代理service，service代理pod.
Ingress基本原理图如下：

kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml

Using NodePort:
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml


查看ingress-nginx组件状态
root># kubectl get pod -n ingress-nginx
NAME                                        READY   STATUS    RESTARTS   AGE
nginx-ingress-controller-568867bf56-mbvm2   1/1     Running   0          4m46s


查看创建的ingress service暴露的端口：
root># kubectl get svc -n ingress-nginx 
NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx   NodePort   10.97.243.123   <none>        80:30725/TCP,443:32314/TCP   5m46s
```

# 二、创建ingress-nginx后端服务
```
# vim deploy-demon.yaml

apiVersion: v1
kind: Service
metadata:
  name: myapp
  namespace: default
spec:
  selector:
    app: myapp
    release: canary
  ports:
  - name: http
    port: 80
    targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
      release: canary
  template:
    metadata:
      labels:
        app: myapp
        release: canary
    spec:
      containers:
      - name: myapp
        image: ikubernetes/myapp:v2
        ports:
        - name: httpd
          containerPort: 80
          
root># kubectl apply -f deploy-demon.yaml

root># kubectl get pods

root># kubectl get svc nginx-web-1
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
nginx-web-1   ClusterIP   10.98.135.189   <none>        80/TCP    32m
```

# 三、创建myapp的ingress规则

```
# vim  ingress-myapp.yaml 

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-myapp
  namespace: default
  annotations:
    kubernets.io/ingress.class: "nginx"
spec:
  rules:
  - host: www.k8s-devops.com
    http:
      paths:
      - path:
        backend:
          serviceName: myapp
          servicePort: 80
          
root># kubectl apply -f ingress-myapp.yaml  

root># kubectl get ingress
NAME            HOSTS                ADDRESS         PORTS   AGE
ingress-myapp   www.k8s-devops.com   10.97.243.123   80      4m17s

```

# 四、查看ingress-default-backend的详细信息：

```
root># kubectl exec -n ingress-nginx -it nginx-ingress-controller-568867bf56-mbvm2 -- /bin/sh

$ cat nginx.conf

        ## start server www.k8s-devops.com
        server {
                server_name www.k8s-devops.com ;

                listen 80  ;
                listen 443  ssl http2 ;

                set $proxy_upstream_name "-";

                ssl_certificate_by_lua_block {
                        certificate.call()
                }

                location / {

                        set $namespace      "default";
                        set $ingress_name   "ingress-myapp";
                        set $service_name   "myapp";
                        set $service_port   "80";
                        set $location_path  "/";
                        
```

# 五、测试域名
```
1、测试一
root># curl -x 10.98.135.189:80 http://www.k8s-devops.com



2、测试二
#配置集群外域名解析，当前测试环境我们使用windows hosts文件进行解析(针对于node节点有公网IP的类型)
92.168.92.56  www.k8s-devops.com  
92.168.92.57  www.k8s-devops.com 
92.168.92.58  www.k8s-devops.com

使用域名进行访问:
www.k8s-devops.com


```

参考资料：

https://github.com/kubernetes/ingress-nginx/blob/04e2ad8fcd51b0741263a37b8e7424ca3979137c/docs/deploy/index.md  官网

https://blog.csdn.net/networken/article/details/85881558   kubernetes部署Ingress-nginx
